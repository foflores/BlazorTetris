@page "/"
@using Tetris.Models
@using Excubo.Blazor.Canvas
@inject IJSRuntime Js

<PageTitle>Tetris</PageTitle>

<div class="row justify-content-center">
  <div class="col-10">
    <div class="d-flex justify-content-center">
      <button class="btn btn-primary m-2" @onclick="@StartGame">Start</button>
      <button class="btn btn-primary m-2" @onclick="@PauseGame">Pause</button>
      <button class="btn btn-primary m-2" @onclick="@Restart">Restart</button>
    </div>
    <div class="d-flex justify-content-center text-white">
      <div class="d-flex m-2">
        <h3 class="me-2">Level:</h3>
        <h3>@Level</h3>
      </div>
      <div class="d-flex m-2">
        @if (IsGameOver)
        {
          <h3 class="text-danger">Game Over</h3>
        }
        else if (IsPaused)
        {
          <h3 class="text-info">Paused</h3>
        }
      </div>
      <div class="d-flex m-2">
        <h3 class="me-2">Points:</h3>
        <h3>@Score</h3>
      </div>
    </div>
    <div class="d-flex justify-content-center">
      <Canvas id="canvas" @ref="_canvas" width="250" height="500"></Canvas>
    </div>
  </div>
</div>

<script>
  function buildCanvas() {
    let height = (80 * window.innerHeight) / 100;
    let canvas = document.querySelector("#canvas");
    canvas.height = height;
    canvas.width = height / 2;
    canvas.style.height = height.toString();
    canvas.style.width = (height / 2).toString();
    return height;
  }

  function addEventListeners(instance) {
    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") {
        instance.invokeMethodAsync("MoveLeft");
      } else if (e.key === "ArrowRight") {
        instance.invokeMethodAsync("MoveRight");
      } else if (e.key === "ArrowUp") {
        instance.invokeMethodAsync("Rotate");
      } else if (e.key === "ArrowDown") {
        instance.invokeMethodAsync("MoveDown");
      } else if (e.key === " ") {
        instance.invokeMethodAsync("JumpDown");
      }
    })
  }

  function clearFocus() {
    document.activeElement.blur()
  }
</script>

@code
{
  private Canvas? _canvas;
  private State? _state;

  private int Level => _state?.Level ?? 1;
  private int Score => _state?.Score ?? 0;
  private bool IsGameOver => _state?.IsGameOver ?? false;
  private bool IsPaused => _state?.IsPaused ?? true;

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    await base.OnAfterRenderAsync(firstRender);
    if (!firstRender)
      return;

    var height = await Js.InvokeAsync<double>("buildCanvas");
    var context = await _canvas!.GetContext2DAsync();
    Grid grid = new(context, height, height / 2, 20, 10);
    _state = new State(grid, 20, 10);
    _state.StatsUpdatedEvent += UpdateState;
    await Js.InvokeVoidAsync("addEventListeners", DotNetObjectReference.Create(this));
  }

  private async Task StartGame()
  {
    await _state!.StartGame();
    await Js.InvokeVoidAsync("clearFocus");
  }
  private async Task PauseGame()
  {
    _state!.PauseGame();
    await Js.InvokeVoidAsync("clearFocus");
  }
  private async Task Restart()
  {
    await _state!.Restart();
    await Js.InvokeVoidAsync("clearFocus");
  }
  private void UpdateState(object? sender, EventArgs e)
  {
    StateHasChanged();
  }
  [JSInvokable]
  public async Task MoveLeft()
  {
    await _state!.MoveLeft();
  }
  [JSInvokable]
  public async Task MoveRight()
  {
    await _state!.MoveRight();
  }
  [JSInvokable]
  public async Task MoveDown()
  {
    await _state!.MoveDown();
  }
  [JSInvokable]
  public async Task JumpDown()
  {
    await _state!.JumpDown();
  }
  [JSInvokable]
  public async Task Rotate()
  {
    await _state!.Rotate();
  }
}
